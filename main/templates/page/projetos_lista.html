<!DOCTYPE html>
{% load static %}
<html>
<head>
  <title>Projetos</title>
  <link rel="stylesheet" href="{% static 'css/projetos_lista.css' %}">
</head>
<body>
  <h1>Projetos Cadastrados</h1>
  <table>
    <tr>
      <th>Nome do Projeto</th>
      <th>Objetivo / justificativa</th>
      <th>Tipo de Conta</th>
      <th>C√≥digo do Produto</th>
      <th>Valores Mensais</th>
      <th>Total</th>
      <th>√â Recorrente?</th>
      <th>Obriga√ß√£o Legal?</th>
      <th>A√ß√µes</th>
    </tr>
    {% for p in projetos %}
    <tr>
      <td>{{ p.nome_projeto }}</td>
      <td>{{ p.justificativa }}</td>
      <td>{{ p.tipo_conta }}</td>
      <td>{{ p.codigo_produto }}</td>
      <td>
        {% if p.valores_mensais %}
          {% for mes, valor in p.valores_mensais.items %}
            <strong>{{ mes|title }}:</strong> R$ {{ valor|floatformat:2 }}<br>
          {% endfor %}
        {% else %}
          -
        {% endif %}
      </td>
      <td>R$ {{ p.valor_total|floatformat:2 }}</td>
      <td>{{ p.e_recorrente }}</td>
      <td>{{ p.obrigacao_legal }}</td>
      <td class="acoes">
        <a href="{% url 'editar_projeto' p.id %}" class="btn-editar" title="Editar projeto">‚úèÔ∏è</a>
        <form method="post" action="{% url 'deletar_projeto' p.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn-deletar" title="Deletar projeto" onclick="return confirm('Tem certeza que deseja deletar este projeto?');">
            üóëÔ∏è
          </button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>

  <div style="margin: 30px 0; padding: 20px; background-color: #f9f9f9; border-radius: 5px;">
    <h2>Informa√ß√µes Adicionais</h2>
    
    <p>
      <label for="nome_gestor">Nome do Gestor:</label>
      <input type="text" id="nome_gestor" placeholder="Digite o nome do gestor" style="width: 100%; padding: 8px; margin-top: 5px;">
    </p>

    <p>
      <label for="setor">Setor:</label>
      <input type="text" id="setor" placeholder="Digite o setor" style="width: 100%; padding: 8px; margin-top: 5px;">
    </p>

    <p>
      <label for="centro_custo">Centro de Custo:</label>
      <select id="centro_custo" style="width: 100%; padding: 8px; margin-top: 5px;">
        <option value="">-- Selecionar Centro de Custo --</option>
      </select>
    </p>
  </div>

  <div class="button-container">
    <a href="#" id="export-link" class="button export-button">üìä Exportar para Excel</a>
    <a href="{% url 'criar_projeto' %}" class="button new-button">‚ûï Novo Projeto</a>
  </div>

  <script>
    // preenche o dropdown de centro de custo a partir do JSON
    fetch('{% static "data/centro_custo.json" %}')
      .then(res => res.json())
      .then(list => {
        const sel = document.getElementById('centro_custo');
        list.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.code + ' - ' + item.name;
          opt.textContent = item.code + ' - ' + item.name;
          sel.appendChild(opt);
        });
      }).catch(err => console.error('Erro carregando centros de custo:', err));

    // Quando clicar em exportar, pega os valores dos inputs e redireciona com query params
    document.getElementById('export-link').addEventListener('click', function (e) {
      e.preventDefault();
      const gestor = encodeURIComponent(document.getElementById('nome_gestor').value || '');
      const setor = encodeURIComponent(document.getElementById('setor').value || '');
      const centro = encodeURIComponent(document.getElementById('centro_custo').value || '');
      // monta a url de exporta√ß√£o com query params
      const url = '{% url "exportar_planilha" %}';
      const sep = url.includes('?') ? '&' : '?';
      window.location.href = url + sep + 'nome_gestor=' + gestor + '&setor=' + setor + '&centro_custo=' + centro;
    });
  </script>
</body>
</html>
